<!doctype html><html><head>
<meta charset="utf-8">
<title>ESP32 NTRIP Base</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet"
 href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
 body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:0}
 header{padding:12px 16px;background:#1e293b;color:#fff}
 main{padding:12px 16px; display:grid; gap:12px}
 .card{background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08); padding:12px}
 #map{height:360px; border-radius:8px}
 label{display:block; margin:.4rem 0 .2rem}
 input{width:100%; padding:.5rem; border:1px solid #cbd5e1; border-radius:8px}
 button{margin-top:.6rem; padding:.6rem 1rem; border:0; border-radius:10px; background:#0ea5e9; color:#fff; cursor:pointer}
 button.secondary{background:#64748b}
 .row{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:8px}
 .hint{color:#64748b; font-size:.9rem}
</style>
</head><body>
<header><strong>ESP32 NTRIP Base – PX1125R</strong></header>
<main>
  <div id="map" class="card"></div>

  <div class="card">
    <div class="row">
      <div><label>Latitude (deg)</label><input id="lat" type="number" step="0.0000001"></div>
      <div><label>Longitude (deg)</label><input id="lon" type="number" step="0.0000001"></div>
      <div><label>Ellipsoidal height (m)</label><input id="alt" type="number" step="0.01"></div>
    </div>
    <div class="hint">Tip: “Use current” fills from the live GNSS (/api/gnss). “Save to GNSS” sends SkyTraq 0x22 (Static) and stores to NVS.</div>
    <button id="btnUse" class="secondary">Use current</button>
    <button id="btnSave">Save to GNSS</button>
  </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
let map = L.map('map').setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
 {maxZoom: 19, attribution:'© OpenStreetMap'}).addTo(map);
let marker = L.marker([0,0]).addTo(map);

async function refreshGnss(){
  try{
    const r = await fetch('/api/gnss'); const j = await r.json();
    if(j.valid){
      marker.setLatLng([j.lat, j.lon]);
      map.setView([j.lat, j.lon], Math.max(map.getZoom(), 15));
    }
  }catch(e){}
}
setInterval(refreshGnss, 1000);
refreshGnss();

document.getElementById('btnUse').onclick = async()=>{
  const r = await fetch('/api/gnss'); const j = await r.json();
  if(j.valid){
    lat.value = j.lat.toFixed(7);
    lon.value = j.lon.toFixed(7);
    alt.value = (j.alt ?? 0).toFixed(2);
  } else alert('No valid fix yet.');
};
document.getElementById('btnSave').onclick = async()=>{
  const body = JSON.stringify({
    lat: parseFloat(lat.value),
    lon: parseFloat(lon.value),
    alt: parseFloat(alt.value),
    saveToFlash: true
  });
  const r = await fetch('/api/base', {method:'POST', headers:{'Content-Type':'application/json'}, body});
  if(r.ok) alert('Base saved and sent to GNSS.');
  else alert('Failed: ' + await r.text());
};

// Prefill from NVS if present
(async()=>{
  const r = await fetch('/api/base'); const j = await r.json();
  if(j.present){ lat.value=j.lat; lon.value=j.lon; alt.value=j.alt; }
})();
</script>
</body></html>
