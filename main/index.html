<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ESP32 NTRIP Base</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet (requires internet unless you embed these locally) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f8fafc}
    header{padding:12px 16px;background:#1e293b;color:#fff}
    main{padding:12px 16px; display:grid; gap:12px}
    .card{background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08); padding:12px}
    #map{height:360px; border-radius:8px}
    label{display:block; margin:.4rem 0 .2rem}
    input{width:100%; padding:.5rem; border:1px solid #cbd5e1; border-radius:8px}
    button{margin-top:.6rem; padding:.6rem 1rem; border:0; border-radius:10px; background:#0ea5e9; color:#fff; cursor:pointer}
    button.secondary{background:#64748b}
    .row{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:8px}
    .hint{color:#64748b; font-size:.9rem}
  </style>
</head>
<body>
  <header><strong>ESP32 NTRIP Base – PX1125R</strong></header>
  <main>
    <div id="map" class="card"></div>

    <div class="card">
      <div class="row">
        <div><label>Latitude (deg)</label><input id="lat" type="number" step="0.0000001" /></div>
        <div><label>Longitude (deg)</label><input id="lon" type="number" step="0.0000001" /></div>
        <div><label>Ellipsoidal height (m)</label><input id="alt" type="number" step="0.01" /></div>
      </div>
      <div class="hint">“Use current” pulls from /api/gnss. “Save to GNSS” sends SkyTraq 0x22 (Static) and stores to NVS.</div>
      <button id="btnUse" class="secondary">Use current</button>
      <button id="btnSave">Save to GNSS</button>
      <button id="btnSurvey">Start 60s Survey-In</button>
    </div>
  </main>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
  // Grab elements safely
  const el = {
    lat: document.getElementById('lat'),
    lon: document.getElementById('lon'),
    alt: document.getElementById('alt'),
    btnUse: document.getElementById('btnUse'),
    btnSave: document.getElementById('btnSave')
  };

  // Map
  let map = L.map('map').setView([0,0], 2);
  //L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  // {maxZoom: 19, attribution:'© OpenStreetMap'}).addTo(map);
  const osm = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { maxZoom: 19, attribution: '© OpenStreetMap' }
);

const esri = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution: 'Tiles &copy; Esri, Maxar, Earthstar Geographics, and the GIS User Community' }
);

// start with satellite
esri.addTo(map);

// layer toggle (top-right)
L.control.layers(
  { 'Satellite (Esri)': esri, 'Street (OSM)': osm },
  null,
  { collapsed: true }
).addTo(map);
  let marker = L.marker([0,0]).addTo(map);

  // Status bar
  const statusBar = document.createElement('div');
  statusBar.style.cssText = 'position:fixed;bottom:12px;left:12px;background:#0008;color:#fff;padding:6px 10px;border-radius:8px;font:12px system-ui';
  statusBar.textContent = 'Waiting for GNSS…';
  document.body.appendChild(statusBar);

  async function fetchJSON(url, opts) {
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), 1500);
    try {
      const r = await fetch(url, { signal: ctrl.signal, ...opts });
      clearTimeout(t);
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    } catch (e) {
      clearTimeout(t);
      throw e;
    }
  }

  let firstFixShown = false;
  async function refreshGnss(){
    try{
      const j = await fetchJSON('/api/gnss');
      if (j.valid) {
        marker.setLatLng([j.lat, j.lon]);
        if (!firstFixShown) {
          map.setView([j.lat, j.lon], 15);
          firstFixShown = true;
        }
        statusBar.textContent = 'GNSS OK';
      } else {
        statusBar.textContent = 'No valid fix yet';
      }
    } catch(e){
      statusBar.textContent = 'GNSS read failed';
    }
  }

  el.btnUse.onclick = async()=>{
    try {
      const j = await fetchJSON('/api/gnss');
      if (j.valid){
        el.lat.value = Number(j.lat).toFixed(7);
        el.lon.value = Number(j.lon).toFixed(7);
        el.alt.value = Number(j.alt ?? 0).toFixed(2);
      } else alert('No valid fix yet.');
    } catch(e){
      alert('Failed to read GNSS.');
    }
  };

  el.btnSave.onclick = async()=>{
    const body = {
      lat: parseFloat(el.lat.value),
      lon: parseFloat(el.lon.value),
      alt: parseFloat(el.alt.value),
      saveToFlash: true
    };
    if (!Number.isFinite(body.lat) || !Number.isFinite(body.lon) || !Number.isFinite(body.alt)) {
      alert('Please enter valid numbers for lat/lon/alt.'); return;
    }
    try{
      const r = await fetch('/api/base', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if (r.ok) alert('Base saved and sent to GNSS.');
      else alert('Failed: ' + await r.text());
    } catch(e){
      alert('Request failed.');
    }
  };

  const btnSurvey = document.getElementById('btnSurvey');
  btnSurvey.onclick = async()=>{
    try{
        const r = await fetch('/api/survey', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
            seconds: 60,       // survey duration
            stddev: 3,         // meters (typical requirement)
            saveToFlash: true  // commit to flash on receiver
        })
        });
        if (r.ok) alert('Survey-In started for 60s.');
        else alert('Failed: ' + await r.text());
    }catch(e){
        alert('Request failed.');
    }
    };

  // live updates (1 Hz)
  refreshGnss();
  setInterval(refreshGnss, 1000);

  // Prefill from NVS if present
  (async()=>{
    try{
      const j = await fetchJSON('/api/base');
      if (j.present){
        el.lat.value=j.lat; el.lon.value=j.lon; el.alt.value=j.alt;
        marker.setLatLng([j.lat, j.lon]);
        map.setView([j.lat, j.lon], 15);
        firstFixShown = true;
      }
    }catch{}
  })();
  </script>
</body>
</html>
